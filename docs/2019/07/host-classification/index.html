<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><title>Host Classification with SaltStack - Timid Robot</title><meta content="Timid Robot Zehta" name="author"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="/static/normalize.css" rel="stylesheet"/><link href="/static/skeleton.css" rel="stylesheet"/><link href="/static/fa/css/fontawesome.css" rel="stylesheet"/><link href="/static/fa/css/brands.css" rel="stylesheet"/><link href="/static/fa/css/solid.css" rel="stylesheet"/><link href="/static/pygments-monokai.css" rel="stylesheet"/><link href="/static/custom.css" rel="stylesheet"/><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/><link href="/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png"/><meta content="Timid Robot's website" property="og:site_name"/><meta content="https://zehta.me.me/" property="og:url"/><meta content="Blog" property="og:title"/><meta content="website" property="og:type"/><meta content="https://zehta.me/robot-solid-cc99ff.svg" property="og:image"/><meta content="image/svg" property="og:image:type"/><meta content="logo" property="og:image:alt"/><script async="" data-domain="zehta.me" defer="" src="https://stats.zehta.me/js/plausible.outbound-links.js"></script><script>window.plausible = window.plausible || function() {(window.plausible.q = window.plausible.q || []).push(arguments) }</script></head><body><nav class="container"><div class="row"><div class="three columns title"><a href="/">Timid Robot</a></div><div class="nine columns navi"><div class="navgroup"><div class="linkinactive"><a class="linkinactive" href="/about/"><i class="fas fa-address-card"></i> About</a></div><div class="linkinactive"><a class="linkinactive" href="/resume/"><i class="fas fa-laptop-code"></i> Résumé</a></div></div><div class="navgroup"><div class="linkinactive"><a class="linkinactive" href="/tags/"><i class="fas fa-tags"></i> Tags</a></div><div class="linkactive"><a class="linkactive" href="/"><i class="fas fa-newspaper"></i> Blog</a></div></div></div></div></nav><div class="container page"><div class="row"><div class="blog-post"><h1>Host Classification with SaltStack</h1><div class="meta">2019 Jul 31, Timid Robot Zehta</div><p>Within infrastructure as code, as with all programming, there is a goal to reduce redundancy as much as possible. With configuration management, duplicated configurations can quickly lead to confusion and unexpected states. One of the key ways to reduce configuration duplication is robust host classification.</p><h3 id="minion-classification">Minion Classification</h3><p>As this post is about SaltStack, the terms "minion classification" for "host classification" and "minion" for "host" are used. With Puppet, "node classification" and "node" would be used.</p><p>Minion classification consists of rules that determine what a minion is and which states (or configurations) should be applied to it. Good minion classification removes or minimizes the necessity of explicitly assigning configurations to a minion. Our goal is for the computer to do as much of the work as possible.</p><h3 id="implementation">Implementation</h3><p>Minions are added and configured from the primary salt server (called the salt-master) with the following Minion ID schema: <strong><code>HST__POD__LOC</code></strong>:</p><ol><li><strong><code>HST</code></strong> is the hostname or role. It indications what services are running on the host or the role that it serves.</li><li><strong><code>POD</code></strong> is the pod or group. It indicates the logical grouping of the host.</li><li><strong><code>LOC</code></strong> is the location. It indicates where the host is.</li></ol><p>Examples:</p><ul><li><code>wordpress__prod__us-east-2</code></li><li><code>wordpress__stage__us-east-2</code></li></ul><p>The Minion ID parts are matched against the following list. SaltStack pillar data, like Apache2, uses a last declared wins model. The following list is organized from least-specific to most-specific:</p><ol><li><code>1_LOC</code> (location)</li><li><code>2_POD</code> (pod/group)</li><li><code>3_HST</code> (host/role)</li><li><code>4_POD__LOC</code> (pod/group and location)</li><li><code>5_HST__POD</code> (host/role and pod/group)</li></ol><p>Using our Minion ID examples above, this allows configuration data to be specified for both shared data (ex. WordPress security settings that should be applied to all WordPress hosts/roles) and specific data (ex. Let's Encrypt TLS/SSL settings).</p><h2 id="security">Security</h2><p><em>The only grain which can be safely used is <code>grains['id']</code> which contains the Minion ID.</em> (<a href="https://docs.saltstack.com/en/latest/faq.html#is-targeting-using-grain-data-secure">FAQ Q.21</a>)</p><p>It is important to rely <em>only</em> on the Minion ID as all other grains can be manipulated by the client. This means a compromised client could change its grains to collect secrets if a dedicated grain (ex. <code>role</code>) was used for minion classification.</p><h3 id="imperfect-work-in-progress">Imperfect Work in Progress</h3><p>This implementation has proven to be robust and helpful. However, there is still room for improvement. For example, I will probably refactor <code>HST</code> to <code>ROLE</code> and <code>POD</code> to <code>GRP</code> for added clarity.</p><p><strong>Feedback and development is welcomed.</strong></p><p>The <a href="https://github.com/creativecommons/sre-salt-prime">creativecommons/sre-salt-prime</a> repository is open source.</p><p>This host classification is also documented within it: <a href="https://github.com/creativecommons/sre-salt-prime/blob/master/docs/Host_Classification.md">sre-salt-prime/Host_Classification.md at master</a>.</p><h2 id="originally-published">Originally Published</h2><p>Originally published <a href="https://opensource.creativecommons.org/blog/entries/saltstack-host-classification/">Host Classification with SaltStack — Creative Commons on GitHub</a></p><div><h2>Tags</h2><ul><li><a href="/tags/2019//"><i class="fas fa-tag"></i> 2019</a></li><li><a href="/tags/creative-commons//"><i class="fas fa-tag"></i> Creative Commons</a></li><li><a href="/tags/floss//"><i class="fas fa-tag"></i> Free/Libre and Open Source Software</a></li><li><a href="/tags/saltstack//"><i class="fas fa-tag"></i> SaltStack</a></li><li><a href="/tags/sysadmin//"><i class="fas fa-tag"></i> Systems Administration</a></li></ul></div></div><hr class="copyright"/><p class="copyright"><a href="https://creativecommons.org/licenses/by/4.0/" rel="license" title="CC BY 4.0"><img alt="CC BY 4.0 license button" src="https://licensebuttons.net/l/by/4.0/80x15.png"/></a> Copyright © 2019 Creative Commons. This work is licensed under a <strong><a href="https://creativecommons.org/licenses/by/4.0/" rel="license" title="Creative Commons Attribution 4.0 International License">Creative Commons Attribution 4.0 International License</a>.</strong></p></div></div><div class="container footer"><div class="post-prev"><a href="/2019/11/empowering-collaboration/"><i class="fas fa-angle-left"></i> Empowering Collaboration in...</a></div><div class="post-next"><a href="/2019/04/open-development/">Open Development with SaltS... <i class="fas fa-angle-right"></i></a></div></div><div class="container bottombot"><i class="fas fa-robot"></i></div></body></html>